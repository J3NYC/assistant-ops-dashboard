<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Assistant Ops Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; line-height: 1.4; }
    input, button { font-size: 1rem; padding: 0.5rem; }
    .row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    ul { padding-left: 1.2rem; }
    code { background: #f4f4f4; padding: 0.1rem 0.3rem; border-radius: 4px; }
    .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.82rem; font-weight: 600; }
    .sev-high { background: #ffe3e3; color: #a40000; }
    .sev-medium { background: #fff4d6; color: #8a5a00; }
    .sev-low { background: #e8f5e9; color: #1f6d2e; }
  </style>
</head>
<body>
  <h1>Assistant Ops Dashboard</h1>
  <p>CI Failure Summarizer (GitHub Actions)</p>

  <div class="row">
    <input id="repo" type="text" placeholder="owner/repo" value="" />
    <label for="severityFilter">Severity:</label>
    <select id="severityFilter">
      <option value="all">All</option>
      <option value="high">High</option>
      <option value="medium">Medium</option>
      <option value="low">Low</option>
    </select>
    <button id="load">Load failures</button>
    <button id="export">Export summary</button>
    <button id="openTop3">Open top 3 high severity</button>
    <label for="autoRefresh">Auto-refresh</label>
    <input id="autoRefresh" type="checkbox" />
  </div>

  <p id="status"></p>
  <ul id="results"></ul>

  <h2>Daily Spend Circuit Breaker</h2>
  <p id="costStatus">Loading cost status...</p>
  <div style="width: 100%; max-width: 640px; background: #eee; border-radius: 8px; overflow: hidden;">
    <div id="costBar" style="height: 18px; width: 0%; background: #2e7d32;"></div>
  </div>
  <p id="costBreakdown"></p>

  <script>
    const repoInput = document.getElementById('repo');
    const severityFilter = document.getElementById('severityFilter');
    const loadBtn = document.getElementById('load');
    const exportBtn = document.getElementById('export');
    const openTop3Btn = document.getElementById('openTop3');
    const autoRefreshEl = document.getElementById('autoRefresh');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const costStatusEl = document.getElementById('costStatus');
    const costBarEl = document.getElementById('costBar');
    const costBreakdownEl = document.getElementById('costBreakdown');

    let latestData = null;
    let autoRefreshTimer = null;

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function getProcessedFailures(data) {
      const severityOrder = { high: 0, medium: 1, low: 2, unknown: 3 };
      const selectedSeverity = (severityFilter.value || 'all').toLowerCase();
      const list = Array.isArray(data?.failures) ? data.failures : [];

      const sorted = [...list].sort((a, b) => {
        const sa = String(a.severity || 'unknown').toLowerCase();
        const sb = String(b.severity || 'unknown').toLowerCase();
        const oa = severityOrder[sa] ?? 99;
        const ob = severityOrder[sb] ?? 99;
        if (oa !== ob) return oa - ob;
        return Number(b.confidence || 0) - Number(a.confidence || 0);
      });

      const filtered = selectedSeverity === 'all'
        ? sorted
        : sorted.filter((f) => String(f.severity || '').toLowerCase() === selectedSeverity);

      return { sorted, filtered };
    }

    function renderFailures(data) {
      const { filtered } = getProcessedFailures(data);
      statusEl.textContent = `${filtered.length} of ${data.count} failed run(s) for ${data.repo}`;

      if (!filtered.length) {
        resultsEl.innerHTML = '<li>No failed runs match that severity filter.</li>';
        return;
      }

      resultsEl.innerHTML = filtered.map((f) => {
        const sha = escapeHtml((f.sha || '').slice(0, 7));
        const reason = escapeHtml(f.failureReason || 'Failure reason unavailable');
        const topFailures = Array.isArray(f.topFailures) ? f.topFailures : [];
        const topFailuresHtml = topFailures.length
          ? `<br/>Likely fail points: ${topFailures.map((x) => `${escapeHtml(x.job)} → ${escapeHtml(x.step)}`).join('; ')}`
          : '';
        const category = escapeHtml(f.failureCategory || 'unknown');
        const hint = escapeHtml(f.fixHint || 'No hint available');
        const confidenceNum = Number(f.confidence || 0);
        const confidencePct = `${Math.round(confidenceNum * 100)}%`;
        const severity = (f.severity || 'low').toLowerCase();
        const severityClass = severity === 'high' ? 'sev-high' : severity === 'medium' ? 'sev-medium' : 'sev-low';
        const snippet = escapeHtml(f.logSnippet || '').slice(0, 350);
        const snippetHtml = snippet ? `<br/><details><summary>Failed log excerpt</summary><pre style="white-space: pre-wrap; background: #f8f8f8; padding: 0.5rem; border-radius: 6px;">${snippet}</pre></details>` : '';

        return `<li><strong>${escapeHtml(f.workflow)}</strong>: ${escapeHtml(f.title)}<br/>Branch: <code>${escapeHtml(f.branch)}</code> · SHA: <code>${sha}</code><br/>Why it failed: ${reason}${topFailuresHtml}<br/>Category: <code>${category}</code> · Confidence: <code>${escapeHtml(confidencePct)}</code> · <span class="badge ${severityClass}">${escapeHtml(severity.toUpperCase())}</span><br/>Hint: ${hint}${snippetHtml}<br/><a href="${escapeHtml(f.url)}" target="_blank" rel="noreferrer">Open run</a></li>`;
      }).join('');
    }

    async function loadCosts() {
      try {
        const res = await fetch('/admin/costs');
        if (!res.ok) {
          costStatusEl.textContent = 'Cost data unavailable';
          return;
        }
        const data = await res.json();
        const spend = Number(data?.spend?.global || 0);
        const limits = data?.limits || { warning: 100, soft: 250, hard: 500, emergency: 1000 };
        const pct = Math.min(100, (spend / limits.emergency) * 100);

        let color = '#2e7d32';
        if (spend >= limits.emergency) color = '#6a1b9a';
        else if (spend >= limits.hard) color = '#c62828';
        else if (spend >= limits.soft) color = '#ef6c00';
        else if (spend >= limits.warning) color = '#f9a825';

        costBarEl.style.width = `${pct}%`;
        costBarEl.style.background = color;
        costStatusEl.textContent = `Spend $${spend.toFixed(2)} / emergency $${Number(limits.emergency).toFixed(2)} (state: ${data.breakerState})`;

        const byModel = data?.spend?.byModel || {};
        const parts = Object.entries(byModel).map(([k, v]) => `${k}: $${Number(v).toFixed(2)}`);
        costBreakdownEl.textContent = parts.length ? `By model — ${parts.join(' · ')}` : 'No spend recorded today.';
      } catch {
        costStatusEl.textContent = 'Cost data request failed';
      }
    }

    async function loadFailures() {
      const repo = repoInput.value.trim();
      resultsEl.innerHTML = '';
      statusEl.textContent = 'Loading...';
      if (!repo) {
        statusEl.textContent = 'Enter a repo as owner/repo.';
        return;
      }

      try {
        const res = await fetch(`/api/ci/failures?repo=${encodeURIComponent(repo)}&limit=5`);
        const data = await res.json();

        if (!res.ok) {
          statusEl.textContent = data?.error?.message || 'Failed to load failures.';
          return;
        }

        latestData = data;
        renderFailures(data);
        loadCosts();
      } catch (err) {
        statusEl.textContent = 'Request failed. Check server logs.';
      }
    }

    function exportSummary() {
      if (!latestData) {
        statusEl.textContent = 'Load failures first, then export.';
        return;
      }
      const { filtered } = getProcessedFailures(latestData);
      const lines = [
        `CI Failure Summary`,
        `Repo: ${latestData.repo}`,
        `Generated: ${new Date().toISOString()}`,
        `Visible failures: ${filtered.length}`,
        ``,
      ];

      filtered.forEach((f, i) => {
        lines.push(`${i + 1}. [${String(f.severity || 'unknown').toUpperCase()} ${Math.round(Number(f.confidence || 0) * 100)}%] ${f.workflow} — ${f.title}`);
        lines.push(`   Branch: ${f.branch}  SHA: ${(f.sha || '').slice(0, 7)}`);
        lines.push(`   Category: ${f.failureCategory || 'unknown'}`);
        lines.push(`   Hint: ${f.fixHint || 'No hint available'}`);
        lines.push(`   URL: ${f.url}`);
        lines.push('');
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeRepo = String(latestData.repo || 'repo').replace('/', '_');
      a.href = url;
      a.download = `ci-failure-summary-${safeRepo}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function openTop3HighSeverity() {
      if (!latestData) {
        statusEl.textContent = 'Load failures first.';
        return;
      }
      const { sorted } = getProcessedFailures(latestData);
      const top3 = sorted.filter((f) => String(f.severity || '').toLowerCase() === 'high').slice(0, 3);
      if (!top3.length) {
        statusEl.textContent = 'No high-severity failures to open.';
        return;
      }
      top3.forEach((f) => window.open(f.url, '_blank', 'noopener,noreferrer'));
    }

    function toggleAutoRefresh() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
      if (autoRefreshEl.checked) {
        autoRefreshTimer = setInterval(() => {
          if (repoInput.value.trim()) loadFailures();
        }, 30000);
      }
    }

    loadBtn.addEventListener('click', loadFailures);
    severityFilter.addEventListener('change', () => {
      if (latestData) renderFailures(latestData);
    });
    exportBtn.addEventListener('click', exportSummary);
    openTop3Btn.addEventListener('click', openTop3HighSeverity);
    autoRefreshEl.addEventListener('change', toggleAutoRefresh);
    loadCosts();
  </script>
</body>
</html>
