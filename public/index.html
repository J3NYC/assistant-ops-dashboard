<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Assistant Ops Dashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; line-height: 1.4; }
    input, button { font-size: 1rem; padding: 0.5rem; }
    .row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    ul { padding-left: 1.2rem; }
    code { background: #f4f4f4; padding: 0.1rem 0.3rem; border-radius: 4px; }
    .badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.82rem; font-weight: 600; }
    .sev-high { background: #ffe3e3; color: #a40000; }
    .sev-medium { background: #fff4d6; color: #8a5a00; }
    .sev-low { background: #e8f5e9; color: #1f6d2e; }
  </style>
</head>
<body>
  <h1>Assistant Ops Dashboard</h1>
  <p>CI Failure Summarizer (GitHub Actions)</p>

  <div class="row">
    <input id="repo" type="text" placeholder="owner/repo" value="" />
    <label for="severityFilter">Severity:</label>
    <select id="severityFilter">
      <option value="all">All</option>
      <option value="high">High</option>
      <option value="medium">Medium</option>
      <option value="low">Low</option>
    </select>
    <button id="load">Load failures</button>
  </div>

  <p id="status"></p>
  <ul id="results"></ul>

  <script>
    const repoInput = document.getElementById('repo');
    const severityFilter = document.getElementById('severityFilter');
    const loadBtn = document.getElementById('load');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    async function loadFailures() {
      const repo = repoInput.value.trim();
      resultsEl.innerHTML = '';
      statusEl.textContent = 'Loading...';
      if (!repo) {
        statusEl.textContent = 'Enter a repo as owner/repo.';
        return;
      }

      try {
        const res = await fetch(`/api/ci/failures?repo=${encodeURIComponent(repo)}&limit=5`);
        const data = await res.json();

        if (!res.ok) {
          statusEl.textContent = data?.error?.message || 'Failed to load failures.';
          return;
        }

        const severityOrder = { high: 0, medium: 1, low: 2, unknown: 3 };
        const selectedSeverity = (severityFilter.value || 'all').toLowerCase();

        const sorted = [...data.failures].sort((a, b) => {
          const sa = String(a.severity || 'unknown').toLowerCase();
          const sb = String(b.severity || 'unknown').toLowerCase();
          const oa = severityOrder[sa] ?? 99;
          const ob = severityOrder[sb] ?? 99;
          if (oa !== ob) return oa - ob;
          return Number(b.confidence || 0) - Number(a.confidence || 0);
        });

        const filtered = selectedSeverity === 'all'
          ? sorted
          : sorted.filter((f) => String(f.severity || '').toLowerCase() === selectedSeverity);

        statusEl.textContent = `${filtered.length} of ${data.count} failed run(s) for ${data.repo}`;

        if (!filtered.length) {
          resultsEl.innerHTML = '<li>No failed runs match that severity filter.</li>';
          return;
        }

        resultsEl.innerHTML = filtered.map((f) => {
          const sha = escapeHtml((f.sha || '').slice(0, 7));
          const reason = escapeHtml(f.failureReason || 'Failure reason unavailable');
          const topFailures = Array.isArray(f.topFailures) ? f.topFailures : [];
          const topFailuresHtml = topFailures.length
            ? `<br/>Likely fail points: ${topFailures.map((x) => `${escapeHtml(x.job)} → ${escapeHtml(x.step)}`).join('; ')}`
            : '';
          const category = escapeHtml(f.failureCategory || 'unknown');
          const hint = escapeHtml(f.fixHint || 'No hint available');
          const confidenceNum = Number(f.confidence || 0);
          const confidencePct = `${Math.round(confidenceNum * 100)}%`;
          const severity = (f.severity || 'low').toLowerCase();
          const severityClass = severity === 'high' ? 'sev-high' : severity === 'medium' ? 'sev-medium' : 'sev-low';
          const snippet = escapeHtml(f.logSnippet || '').slice(0, 350);
          const snippetHtml = snippet ? `<br/><details><summary>Failed log excerpt</summary><pre style="white-space: pre-wrap; background: #f8f8f8; padding: 0.5rem; border-radius: 6px;">${snippet}</pre></details>` : '';

          return `<li><strong>${escapeHtml(f.workflow)}</strong>: ${escapeHtml(f.title)}<br/>Branch: <code>${escapeHtml(f.branch)}</code> · SHA: <code>${sha}</code><br/>Why it failed: ${reason}${topFailuresHtml}<br/>Category: <code>${category}</code> · Confidence: <code>${escapeHtml(confidencePct)}</code> · <span class="badge ${severityClass}">${escapeHtml(severity.toUpperCase())}</span><br/>Hint: ${hint}${snippetHtml}<br/><a href="${escapeHtml(f.url)}" target="_blank" rel="noreferrer">Open run</a></li>`;
        }).join('');
      } catch (err) {
        statusEl.textContent = 'Request failed. Check server logs.';
      }
    }

    loadBtn.addEventListener('click', loadFailures);
    severityFilter.addEventListener('change', loadFailures);
  </script>
</body>
</html>
